
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Idea General &#8212; Mi Portafolio de Ciencia de Datos</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'proyectos/proyecto5';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Mi Portafolio de Ciencia de Datos</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Bienvenido a Mi Portafolio de Inteligencia Artificial y Ciencia de Datos
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="proyecto1.html">Modelo PPO para CartPole (En desarrollo)</a></li>

<li class="toctree-l1"><a class="reference internal" href="proyecto2.html">Optimización No Lineal con PyTorch</a></li>










<li class="toctree-l1"><a class="reference internal" href="proyecto3.html">Capsnet</a></li>

<li class="toctree-l1"><a class="reference internal" href="proyecto4.html">Estimación de Parámetros en Ecuaciones Diferenciales Estocásticas (En desarrollo)</a></li>

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/proyectos/proyecto5.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Idea General</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p>A continuación se presenta una guía estilo notebook con explicaciones, derivaciones matemáticas y ejemplos visuales para ilustrar el procedimiento de estimación no paramétrica de las funciones de deriva (drift) y difusión a partir de datos que representan una trayectoria discreta de un proceso estocástico que satisface la ecuación diferencial estocástica (EDE):</p>
<div class="math notranslate nohighlight">
\[dX_t = a(X_t, t)\,dt + b(X_t, t)\, dW_t,\]</div>
<p>donde  <span class="math notranslate nohighlight">\(X_t\)</span>  es el estado del proceso en el tiempo  t , <span class="math notranslate nohighlight">\( a(\cdot,\cdot)\)</span>  es la función de deriva,  <span class="math notranslate nohighlight">\(b(\cdot,\cdot)\)</span>  es la función de difusión, y  <span class="math notranslate nohighlight">\(W_t\)</span>  es un proceso de Wiener estándar (Browniano).</p>
<section id="idea-general">
<h1>Idea General<a class="headerlink" href="#idea-general" title="Link to this heading">#</a></h1>
<p>Tenemos una trayectoria observada  <span class="math notranslate nohighlight">\(\{ X_{t_i} \}_{i=0}^n\)</span>  del proceso, donde  <span class="math notranslate nohighlight">\(t_0 &lt; t_1 &lt; \dots &lt; t_n\)</span>  son los tiempos de muestreo. Queremos estimar  <span class="math notranslate nohighlight">\(a(x,t)\)</span>  y  <span class="math notranslate nohighlight">\(b(x,t)\)</span>  usando técnicas no paramétricas.</p>
<p>La estrategia clásica es la siguiente:</p>
<ol class="arabic simple">
<li><p>Discretización del incrementos:</p></li>
</ol>
<p>Del modelo:</p>
<div class="math notranslate nohighlight">
\[X_{t+\Delta t} - X_t = a(X_t, t)\Delta t + b(X_t, t)\Delta W_t\]</div>
<p>Donde <span class="math notranslate nohighlight">\(\Delta W_t \sim \mathcal{N}(0, \Delta t)\)</span>.
Para pequeños <span class="math notranslate nohighlight">\(\Delta t = t_{i+1}-t_i\)</span>, podemos aproximar:</p>
<div class="math notranslate nohighlight">
\[\Delta X_i := X_{t_{i+1}} - X_{t_i} \approx a(X_{t_i}, t_i)\Delta t + b(X_{t_i}, t_i)\sqrt{\Delta t} Z_i\]</div>
<p>con  <span class="math notranslate nohighlight">\(Z_i \sim \mathcal{N}(0,1)\)</span> .</p>
<ol class="arabic simple" start="2">
<li><p>Estimación de  <span class="math notranslate nohighlight">\(a(x,t)\)</span> :</p></li>
</ol>
<p>Considerando el promedio condicional:</p>
<div class="math notranslate nohighlight">
\[\mathbb{E}[\Delta X_i \mid X_{t_i}=x, t_i = t] \approx a(x,t)\Delta t\]</div>
<p>Luego,</p>
<div class="math notranslate nohighlight">
\[a(x,t) \approx \frac{\mathbb{E}[\Delta X_i \mid X_{t_i} \approx x, t_i \approx t]}{\Delta t}\]</div>
<p>De manera no paramétrica, podemos usar métodos de suavizado (por ejemplo, kernel smoothing) sobre los pares <span class="math notranslate nohighlight">\((X_{t_i}, t_i)\)</span> para estimar la media condicional de <span class="math notranslate nohighlight">\(\Delta X_i\)</span>.</p>
<ol class="arabic simple" start="3">
<li><p>Estimación de  <span class="math notranslate nohighlight">\(b(x,t)\)</span> :</p></li>
</ol>
<p>De la varianza condicional se tiene:</p>
<div class="math notranslate nohighlight">
\[\text{Var}(\Delta X_i \mid X_{t_i}=x, t_i=t) = b(x,t)^2 \Delta t\]</div>
<p>Por lo que:</p>
<div class="math notranslate nohighlight">
\[b(x,t) \approx \sqrt{\frac{\text{Var}(\Delta X_i \mid X_{t_i} \approx x, t_i \approx t)}{\Delta t}}\]</div>
<p>Nuevamente, de forma no paramétrica, se puede estimar la varianza condicional de <span class="math notranslate nohighlight">\(\Delta X_i\)</span> dado <span class="math notranslate nohighlight">\(X_{t_i}\approx x y t_i \approx t\)</span>.</p>
<ol class="arabic simple" start="4">
<li><p>No parámétrico (Kernel Smoothing):</p></li>
</ol>
<p>Una técnica típica es usar un kernel estimator en el espacio de estados y tiempo. Por ejemplo, definimos un kernel bidimensional  <span class="math notranslate nohighlight">\(K_h(\cdot,\cdot)\)</span>  con ancho de ventana  h . Para un punto <span class="math notranslate nohighlight">\((x,t)\)</span>:</p>
<div class="math notranslate nohighlight">
\[\hat{a}(x,t) = \frac{\sum_i K_h(X_{t_i}-x, t_i-t)\Delta X_i}{\sum_i K_h(X_{t_i}-x, t_i-t)\Delta t}\]</div>
<p>Análogamente:</p>
<div class="math notranslate nohighlight">
\[\hat{b}(x,t)^2 = \frac{\sum_i K_h(X_{t_i}-x, t_i-t)(\Delta X_i - \hat{a}(x,t)\Delta t)^2}{\sum_i K_h(X_{t_i}-x, t_i-t)} \frac{1}{\Delta t}\]</div>
<p>Y finalmente:</p>
<div class="math notranslate nohighlight">
\[\hat{b}(x,t) = \sqrt{\hat{b}(x,t)^2}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KernelDensity</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parámetros de la simulación</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="mf">10.0</span>   <span class="c1"># tiempo total</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># número de pasos</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">n</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Verdaderas funciones de drift y difusión:</span>
<span class="k">def</span> <span class="nf">a_true</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">b_true</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Simulación de Euler-Maruyama</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># condición inicial</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a_true</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">dt</span> <span class="o">+</span> <span class="n">b_true</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>

<span class="c1"># Incrementos</span>
<span class="n">dX</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">t_mid</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Definir el rango del estado</span>
<span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">num_bins</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">bin_centers</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="c1"># Arrays para guardar estimaciones</span>
<span class="n">a_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
<span class="n">b_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>

<span class="c1"># Asignar a cada punto X[i] un bin</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bins</span><span class="p">):</span>
    <span class="c1"># Tomar todos los incrementos con X_t en el bin j</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># asegurarse de tener suficientes puntos</span>
        <span class="n">dX_bin</span> <span class="o">=</span> <span class="n">dX</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="c1"># Estimación a(x) ~ mean(dX)/dt</span>
        <span class="n">a_est</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dX_bin</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span>
        <span class="c1"># Estimación b(x)^2 ~ var(dX)/dt</span>
        <span class="n">b_est</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dX_bin</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a_est</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">b_est</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valores verdaderos en los centros de los bins</span>
<span class="n">a_true_vals</span> <span class="o">=</span> <span class="n">a_true</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">b_true_vals</span> <span class="o">=</span> <span class="n">b_true</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a_estimada&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">a_true_vals</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a_verdadera&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;a(x)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Estimación de la deriva&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">b_est</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b_estimada&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">b_true_vals</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b_verdadera&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;b(x)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Estimación de la difusión&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/825c86da58e92131085d0095cf8981ff1ff9f3ace6e8690417595dda432f21ed.png" src="../_images/825c86da58e92131085d0095cf8981ff1ff9f3ace6e8690417595dda432f21ed.png" />
</div>
</div>
<p>Estimación no paramétrica</p>
<p>Vamos a discretizar el espacio de estados en una rejilla y utilizar un método simple de kernel smoothing unidimensional para estimar la relación entre <span class="math notranslate nohighlight">\(\Delta X\)</span> y <span class="math notranslate nohighlight">\(X_t\)</span>. Para simplificar, en este ejemplo ignoraremos la dependencia explícita en t, asumiendo que a y b dependen sólo de x. (En un caso más complejo, se puede usar un kernel en el espacio bidimensional <span class="math notranslate nohighlight">\((x,t)\)</span>.)</p>
<p>Idea sencilla:</p>
<p>•	Binnea el espacio de estados y, para cada bin, calcula la media y varianza de <span class="math notranslate nohighlight">\(\Delta X\)</span>.</p>
<p>•	Esto es una aproximación no paramétrica muy básica.</p>
<p>•	Para un enfoque más sofisticado, se usaría kernel smoothing.</p>
<p>Estimación por binning</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Funciones de simulación genéricas</span>
<span class="k">def</span> <span class="nf">simulate_sde</span><span class="p">(</span><span class="n">a_func</span><span class="p">,</span> <span class="n">b_func</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">n</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">dt</span> <span class="o">+</span> <span class="n">b_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span>

<span class="k">def</span> <span class="nf">estimate_ab</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dX</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bin_centers</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    
    <span class="n">a_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
    <span class="n">b_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bins</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">dX_bin</span> <span class="o">=</span> <span class="n">dX</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">a_est</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dX_bin</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">b_est</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dX_bin</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a_est</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">b_est</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
    <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="n">b_est</span>

<span class="k">def</span> <span class="nf">plot_estimation</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="n">b_est</span><span class="p">,</span> <span class="n">a_true</span><span class="p">,</span> <span class="n">b_true</span><span class="p">):</span>
    <span class="c1"># Evaluar las funciones verdaderas en los bin_centers</span>
    <span class="n">a_tv</span> <span class="o">=</span> <span class="n">a_true</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">b_tv</span> <span class="o">=</span> <span class="n">b_true</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a_estimada&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">a_tv</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a_verdadera&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;a(x)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimación de la deriva&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">b_est</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b_estimada&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">b_tv</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b_verdadera&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;b(x)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimación de la difusión&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">###################################</span>
<span class="c1"># 1. Movimiento Browniano Aritmético</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_abm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_abm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">t_abm</span><span class="p">,</span> <span class="n">X_abm</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_abm</span><span class="p">,</span> <span class="n">b_abm</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">bin_centers_abm</span><span class="p">,</span> <span class="n">a_est_abm</span><span class="p">,</span> <span class="n">b_est_abm</span> <span class="o">=</span> <span class="n">estimate_ab</span><span class="p">(</span><span class="n">X_abm</span><span class="p">,</span> <span class="n">t_abm</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">bin_centers_abm</span><span class="p">,</span> <span class="n">a_est_abm</span><span class="p">,</span> <span class="n">b_est_abm</span><span class="p">,</span> <span class="n">a_abm</span><span class="p">,</span> <span class="n">b_abm</span><span class="p">)</span>

<span class="c1">###################################</span>
<span class="c1"># 2. Movimiento Browniano Geométrico (GBM)</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_gbm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">b_gbm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.25</span>
    <span class="k">return</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">x</span>

<span class="n">t_gbm</span><span class="p">,</span> <span class="n">X_gbm</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_gbm</span><span class="p">,</span> <span class="n">b_gbm</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">bin_centers_gbm</span><span class="p">,</span> <span class="n">a_est_gbm</span><span class="p">,</span> <span class="n">b_est_gbm</span> <span class="o">=</span> <span class="n">estimate_ab</span><span class="p">(</span><span class="n">X_gbm</span><span class="p">,</span> <span class="n">t_gbm</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">bin_centers_gbm</span><span class="p">,</span> <span class="n">a_est_gbm</span><span class="p">,</span> <span class="n">b_est_gbm</span><span class="p">,</span> <span class="n">a_gbm</span><span class="p">,</span> <span class="n">b_gbm</span><span class="p">)</span>

<span class="c1">###################################</span>
<span class="c1"># 3. Ornstein-Uhlenbeck (OU)</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">t_ou</span><span class="p">,</span> <span class="n">X_ou</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_ou</span><span class="p">,</span> <span class="n">b_ou</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">bin_centers_ou</span><span class="p">,</span> <span class="n">a_est_ou</span><span class="p">,</span> <span class="n">b_est_ou</span> <span class="o">=</span> <span class="n">estimate_ab</span><span class="p">(</span><span class="n">X_ou</span><span class="p">,</span> <span class="n">t_ou</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">bin_centers_ou</span><span class="p">,</span> <span class="n">a_est_ou</span><span class="p">,</span> <span class="n">b_est_ou</span><span class="p">,</span> <span class="n">a_ou</span><span class="p">,</span> <span class="n">b_ou</span><span class="p">)</span>

<span class="c1">###################################</span>
<span class="c1"># 4. Ejemplo Más Complejo</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_complex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="c1"># deriva no lineal, por ejemplo: sin(x)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_complex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="c1"># difusión dependiente del estado: sqrt(0.1 + 0.05 x^2)</span>
    <span class="c1"># Hay que devolver un array del mismo tamaño que x</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">t_complex</span><span class="p">,</span> <span class="n">X_complex</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_complex</span><span class="p">,</span> <span class="n">b_complex</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">bin_centers_complex</span><span class="p">,</span> <span class="n">a_est_complex</span><span class="p">,</span> <span class="n">b_est_complex</span> <span class="o">=</span> <span class="n">estimate_ab</span><span class="p">(</span><span class="n">X_complex</span><span class="p">,</span> <span class="n">t_complex</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">bin_centers_complex</span><span class="p">,</span> <span class="n">a_est_complex</span><span class="p">,</span> <span class="n">b_est_complex</span><span class="p">,</span> <span class="n">a_complex</span><span class="p">,</span> <span class="n">b_complex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1b00d64c854b80f85cdb605b126a4d3ed07f1fe4e8e1aae695257651b6b68de3.png" src="../_images/1b00d64c854b80f85cdb605b126a4d3ed07f1fe4e8e1aae695257651b6b68de3.png" />
<img alt="../_images/e4b6fcb0e0c96a70b3d2011e4be4a047da9349535752d3d24659ce25a4711afb.png" src="../_images/e4b6fcb0e0c96a70b3d2011e4be4a047da9349535752d3d24659ce25a4711afb.png" />
<img alt="../_images/0202fc16be581d39555393312d74bf2b214f59bf532fb077c1945281e26bbadb.png" src="../_images/0202fc16be581d39555393312d74bf2b214f59bf532fb077c1945281e26bbadb.png" />
<img alt="../_images/3723be75fc60d8e295de0ccffb612792eb0a7c71beec6e2f7892116bbcde150d.png" src="../_images/3723be75fc60d8e295de0ccffb612792eb0a7c71beec6e2f7892116bbcde150d.png" />
</div>
</div>
<p>A continuación presento una mejora respecto del estimador Nadaraya-Watson utilizando regresión local lineal (Local Linear Regression), un método que suele reducir el sesgo cerca de los bordes y producir estimaciones más estables que Nadaraya-Watson. Posteriormente, compararemos los resultados con los cuatro modelos de ejemplo propuestos anteriormente:</p>
<ol class="arabic simple">
<li><p>Movimiento Browniano Aritmético (ABM)</p></li>
<li><p>Movimiento Browniano Geométrico (GBM)</p></li>
<li><p>Proceso Ornstein-Uhlenbeck (OU)</p></li>
<li><p>Un proceso complejo con deriva \sin(x) y difusión \sqrt{0.1 + 0.05x^2}</p></li>
</ol>
<p>Regresión Local Lineal</p>
<p>La idea es, para cada punto  <span class="math notranslate nohighlight">\(x_0\)</span>  donde se quiere estimar la función  <span class="math notranslate nohighlight">\(m(x) = \mathbb{E}[Y|X=x]\)</span> :</p>
<ol class="arabic simple">
<li><p>Calcular pesos  <span class="math notranslate nohighlight">\(w_i = K\left(\frac{X_i - x_0}{h}\right)\)</span>  para cada muestra  <span class="math notranslate nohighlight">\((X_i, Y_i)\)</span> .</p></li>
<li><p>Ajustar una regresión lineal ponderada:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[Y_i \approx \alpha + \beta (X_i - x_0)\]</div>
<p>minimizando el error cuadrático con pesos <span class="math notranslate nohighlight">\(w_i\)</span>.</p>
<ol class="arabic simple" start="3">
<li><p>La estimación local lineal en  <span class="math notranslate nohighlight">\(x_0\)</span>  es <span class="math notranslate nohighlight">\(\hat{m}(x_0) = \hat{\alpha}\)</span>, es decir el intercepto del ajuste local.</p></li>
</ol>
<p>Este método se puede aplicar de manera análoga tanto para estimar <span class="math notranslate nohighlight">\(\hat{a}(x)\)</span> (deriva) como para la varianza condicional necesaria para <span class="math notranslate nohighlight">\(\hat{b}(x)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">gaussian_kernel</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">epanechnikov_kernel</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.75</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">local_linear_estimate</span><span class="p">(</span><span class="n">x_eval</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estima E[Y|X=x_eval] usando regresión local lineal.</span>
<span class="sd">    X, Y: datos (1D arrays)</span>
<span class="sd">    x_eval: puntos en donde estimar la función (array 1D)</span>
<span class="sd">    h: ancho de banda</span>
<span class="sd">    kernel: &#39;gaussian&#39; o &#39;epanechnikov&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">gaussian_kernel</span>
    <span class="k">elif</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;epanechnikov&#39;</span><span class="p">:</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">epanechnikov_kernel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Kernel no soportado.&quot;</span><span class="p">)</span>

    <span class="n">Y_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_eval</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_eval</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="n">h</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="c1"># Ajustar el modelo lineal local: Y = alpha + beta*(X - x0)</span>
        <span class="c1"># Matriz del diseño: [ [w, w*(X_i - x0)] ]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">X_design</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span> <span class="o">-</span> <span class="n">x0</span><span class="p">))</span>
        
        <span class="c1"># (X^T W X)^{-1} X^T W Y</span>
        <span class="n">XT</span> <span class="o">=</span> <span class="n">X_design</span><span class="o">.</span><span class="n">T</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">XT</span> <span class="o">@</span> <span class="n">W</span> <span class="o">@</span> <span class="n">X_design</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e12</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">XT</span> <span class="o">@</span> <span class="n">W</span> <span class="o">@</span> <span class="n">Y</span><span class="p">)</span>
            <span class="c1"># theta = [alpha, beta], queremos la prediccion en x0 =&gt; alpha</span>
            <span class="n">Y_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Y_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">Y_est</span>

<span class="k">def</span> <span class="nf">estimate_ab_local_linear</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">x_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dX</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">X_prev</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">x_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_prev</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_prev</span><span class="p">)</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Estimar a(x) = E[dX/dt | X]</span>
    <span class="n">a_est</span> <span class="o">=</span> <span class="n">local_linear_estimate</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">X_prev</span><span class="p">,</span> <span class="n">dX</span><span class="o">/</span><span class="n">dt</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

    <span class="c1"># Estimar b(x):</span>
    <span class="c1"># Var(dX|X=x)* = E[(dX - a(x)*dt)^2 | X=x]</span>
    <span class="c1"># =&gt; b^2(x) = Var(dX|X=x)/dt</span>
    <span class="n">b_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_grid</span><span class="p">):</span>
        <span class="n">a_x0</span> <span class="o">=</span> <span class="n">a_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a_x0</span><span class="p">):</span>
            <span class="n">b_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">continue</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">dX</span> <span class="o">-</span> <span class="n">a_x0</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">var_est</span> <span class="o">=</span> <span class="n">local_linear_estimate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="p">]),</span> <span class="n">X_prev</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">var_est</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">b_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="n">b_est</span>

<span class="k">def</span> <span class="nf">plot_estimation</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="n">b_est</span><span class="p">,</span> <span class="n">a_true</span><span class="p">,</span> <span class="n">b_true</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">a_tv</span> <span class="o">=</span> <span class="n">a_true</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">b_tv</span> <span class="o">=</span> <span class="n">b_true</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a_estimada (local linear)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_tv</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a_verdadera&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;a(x)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Deriva &#39;</span> <span class="o">+</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">b_est</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b_estimada (local linear)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">b_tv</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b_verdadera&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;b(x)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Difusión &#39;</span> <span class="o">+</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">simulate_sde</span><span class="p">(</span><span class="n">a_func</span><span class="p">,</span> <span class="n">b_func</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">n</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">dt</span> <span class="o">+</span> <span class="n">b_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span>

<span class="c1">###################################</span>
<span class="c1"># 1. Movimiento Browniano Aritmético (ABM)</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_abm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_abm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">t_abm</span><span class="p">,</span> <span class="n">X_abm</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_abm</span><span class="p">,</span> <span class="n">b_abm</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">x_grid_abm</span><span class="p">,</span> <span class="n">a_est_abm</span><span class="p">,</span> <span class="n">b_est_abm</span> <span class="o">=</span> <span class="n">estimate_ab_local_linear</span><span class="p">(</span><span class="n">X_abm</span><span class="p">,</span> <span class="n">t_abm</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">x_grid_abm</span><span class="p">,</span> <span class="n">a_est_abm</span><span class="p">,</span> <span class="n">b_est_abm</span><span class="p">,</span> <span class="n">a_abm</span><span class="p">,</span> <span class="n">b_abm</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;(ABM)&quot;</span><span class="p">)</span>

<span class="c1">###################################</span>
<span class="c1"># 2. Movimiento Browniano Geométrico (GBM)</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_gbm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="o">*</span><span class="n">x</span>

<span class="k">def</span> <span class="nf">b_gbm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.25</span>
    <span class="k">return</span> <span class="n">beta</span><span class="o">*</span><span class="n">x</span>

<span class="n">t_gbm</span><span class="p">,</span> <span class="n">X_gbm</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_gbm</span><span class="p">,</span> <span class="n">b_gbm</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">x_grid_gbm</span><span class="p">,</span> <span class="n">a_est_gbm</span><span class="p">,</span> <span class="n">b_est_gbm</span> <span class="o">=</span> <span class="n">estimate_ab_local_linear</span><span class="p">(</span><span class="n">X_gbm</span><span class="p">,</span> <span class="n">t_gbm</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">x_grid_gbm</span><span class="p">,</span> <span class="n">a_est_gbm</span><span class="p">,</span> <span class="n">b_est_gbm</span><span class="p">,</span> <span class="n">a_gbm</span><span class="p">,</span> <span class="n">b_gbm</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;(GBM)&quot;</span><span class="p">)</span>

<span class="c1">###################################</span>
<span class="c1"># 3. Ornstein-Uhlenbeck (OU)</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">t_ou</span><span class="p">,</span> <span class="n">X_ou</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_ou</span><span class="p">,</span> <span class="n">b_ou</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">x_grid_ou</span><span class="p">,</span> <span class="n">a_est_ou</span><span class="p">,</span> <span class="n">b_est_ou</span> <span class="o">=</span> <span class="n">estimate_ab_local_linear</span><span class="p">(</span><span class="n">X_ou</span><span class="p">,</span> <span class="n">t_ou</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">x_grid_ou</span><span class="p">,</span> <span class="n">a_est_ou</span><span class="p">,</span> <span class="n">b_est_ou</span><span class="p">,</span> <span class="n">a_ou</span><span class="p">,</span> <span class="n">b_ou</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;(OU)&quot;</span><span class="p">)</span>

<span class="c1">###################################</span>
<span class="c1"># 4. Proceso complejo</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_complex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_complex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">t_complex</span><span class="p">,</span> <span class="n">X_complex</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_complex</span><span class="p">,</span> <span class="n">b_complex</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">x_grid_complex</span><span class="p">,</span> <span class="n">a_est_complex</span><span class="p">,</span> <span class="n">b_est_complex</span> <span class="o">=</span> <span class="n">estimate_ab_local_linear</span><span class="p">(</span><span class="n">X_complex</span><span class="p">,</span> <span class="n">t_complex</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">x_grid_complex</span><span class="p">,</span> <span class="n">a_est_complex</span><span class="p">,</span> <span class="n">b_est_complex</span><span class="p">,</span> <span class="n">a_complex</span><span class="p">,</span> <span class="n">b_complex</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;(Complejo)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9190bb74e45ce3971aec595b4b685be520fc354c69a93bf12b724f4c8148cd90.png" src="../_images/9190bb74e45ce3971aec595b4b685be520fc354c69a93bf12b724f4c8148cd90.png" />
<img alt="../_images/e67f28cb73898577b9898a53ee87b1a8e73edcdc48b4b307d81b389fd4c4f92d.png" src="../_images/e67f28cb73898577b9898a53ee87b1a8e73edcdc48b4b307d81b389fd4c4f92d.png" />
<img alt="../_images/f74ade8d0131419c4ccaf4de999de679c53fd1c499207d7699956980310ff759.png" src="../_images/f74ade8d0131419c4ccaf4de999de679c53fd1c499207d7699956980310ff759.png" />
<img alt="../_images/fbdabdc81a5111467c80b708f5cd365e905c05fcaab83cd90860556376b5022b.png" src="../_images/fbdabdc81a5111467c80b708f5cd365e905c05fcaab83cd90860556376b5022b.png" />
</div>
</div>
<p>A continuación se muestra cómo adaptar el enfoque previo para utilizar un modelo paramétrico de tipo Gradient Boosting, concretamente LightGBM, en lugar de modelos no paramétricos. La idea será:</p>
<ol class="arabic simple">
<li><p>Simular datos de un SDE (como antes).</p></li>
<li><p>Generar un conjunto de entrenamiento a partir de los pares <span class="math notranslate nohighlight">\((X_{t_i}, dX_i/dt)\)</span> para entrenar un modelo que estime la deriva a(x).</p></li>
<li><p>Una vez obtenidas las predicciones de <span class="math notranslate nohighlight">\(a(x)\)</span>, calcular los residuos para estimar la varianza condicional y así entrenar un segundo modelo que prediga <span class="math notranslate nohighlight">\((dX - a(x)*dt)^2/dt\)</span>, es decir la varianza condicional. De esta forma, a partir de este segundo modelo podremos obtener <span class="math notranslate nohighlight">\(b(x) = \sqrt{\hat{\text{var}}}\)</span>.</p></li>
</ol>
<p>Este método es paramétrico en el sentido de que entrenamos modelos tipo “machine learning” (LightGBM) para aproximar las funciones.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>

<span class="c1"># Funciones para simular el SDE</span>
<span class="k">def</span> <span class="nf">simulate_sde</span><span class="p">(</span><span class="n">a_func</span><span class="p">,</span> <span class="n">b_func</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">n</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">dt</span> <span class="o">+</span> <span class="n">b_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span>

<span class="k">def</span> <span class="nf">plot_estimation</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="n">b_est</span><span class="p">,</span> <span class="n">a_true</span><span class="p">,</span> <span class="n">b_true</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">a_tv</span> <span class="o">=</span> <span class="n">a_true</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">b_tv</span> <span class="o">=</span> <span class="n">b_true</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a_estimada (LightGBM)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_tv</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a_verdadera&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;a(x)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Deriva &#39;</span> <span class="o">+</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">b_est</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b_estimada (LightGBM)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">b_tv</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b_verdadera&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;b(x)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Difusión &#39;</span> <span class="o">+</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Función genérica para estimar a(x) y b(x) usando LightGBM</span>
<span class="k">def</span> <span class="nf">estimate_ab_lightgbm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dX</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">X_prev</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Entrenar modelo para a(x): objetivo = dX/dt</span>
    <span class="n">Y_a</span> <span class="o">=</span> <span class="n">dX</span><span class="o">/</span><span class="n">dt</span>
    <span class="c1"># LightGBM requiere datos 2D para X. Por simplicidad, usamos solo X como feature.</span>
    <span class="c1"># Si se quisieran más características, se podrían agregar.</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_prev</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">Y_train</span> <span class="o">=</span> <span class="n">Y_a</span>
    
    <span class="c1"># Entrenar LightGBM para a(x)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;regression&#39;</span><span class="p">,</span>
        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="mi">123</span>
    <span class="p">}</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
    <span class="n">model_a</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># Predecir a(x) en el conjunto de entrenamiento</span>
    <span class="n">a_pred_train</span> <span class="o">=</span> <span class="n">model_a</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    
    <span class="c1"># Ahora entrenar el modelo para varianza:</span>
    <span class="c1"># var = E((dX - a(X)*dt)^2)/dt</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="p">((</span><span class="n">dX</span> <span class="o">-</span> <span class="n">a_pred_train</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span>
    <span class="n">train_data_b</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">residuals</span><span class="p">)</span>
    <span class="n">model_b</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">train_data_b</span><span class="p">,</span> <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># Devolver los modelos entrenados</span>
    <span class="k">return</span> <span class="n">model_a</span><span class="p">,</span> <span class="n">model_b</span>

<span class="k">def</span> <span class="nf">predict_ab_lightgbm</span><span class="p">(</span><span class="n">model_a</span><span class="p">,</span> <span class="n">model_b</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">):</span>
    <span class="n">a_est</span> <span class="o">=</span> <span class="n">model_a</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">var_est</span> <span class="o">=</span> <span class="n">model_b</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># esto es b^2(x)*dt / dt = b^2(x)</span>
    <span class="c1"># Ojo: var_est ya es la varianza/dt ? </span>
    <span class="c1"># En el entrenamiento definimos residual = ((dX - a*dt)^2)/dt,</span>
    <span class="c1"># por lo que model_b predice directamente Var(dX|X)/dt.</span>
    <span class="c1"># Dado que Var(dX|X) = b^2(x)*dt, Var(dX|X)/dt = b^2(x).</span>
    <span class="c1"># Por lo tanto var_est = b^2(x).</span>
    <span class="n">b_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_est</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a_est</span><span class="p">,</span> <span class="n">b_est</span>


<span class="c1">###################################</span>
<span class="c1"># 1. Movimiento Browniano Aritmético (ABM)</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_abm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_abm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">t_abm</span><span class="p">,</span> <span class="n">X_abm</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_abm</span><span class="p">,</span> <span class="n">b_abm</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">model_a_abm</span><span class="p">,</span> <span class="n">model_b_abm</span> <span class="o">=</span> <span class="n">estimate_ab_lightgbm</span><span class="p">(</span><span class="n">X_abm</span><span class="p">,</span> <span class="n">t_abm</span><span class="p">)</span>
<span class="n">x_grid_abm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_abm</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_abm</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">a_est_abm</span><span class="p">,</span> <span class="n">b_est_abm</span> <span class="o">=</span> <span class="n">predict_ab_lightgbm</span><span class="p">(</span><span class="n">model_a_abm</span><span class="p">,</span> <span class="n">model_b_abm</span><span class="p">,</span> <span class="n">x_grid_abm</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">x_grid_abm</span><span class="p">,</span> <span class="n">a_est_abm</span><span class="p">,</span> <span class="n">b_est_abm</span><span class="p">,</span> <span class="n">a_abm</span><span class="p">,</span> <span class="n">b_abm</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;(ABM)&quot;</span><span class="p">)</span>

<span class="c1">###################################</span>
<span class="c1"># 2. Movimiento Browniano Geométrico (GBM)</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_gbm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="o">*</span><span class="n">x</span>

<span class="k">def</span> <span class="nf">b_gbm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.25</span>
    <span class="k">return</span> <span class="n">beta</span><span class="o">*</span><span class="n">x</span>

<span class="n">t_gbm</span><span class="p">,</span> <span class="n">X_gbm</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_gbm</span><span class="p">,</span> <span class="n">b_gbm</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">model_a_gbm</span><span class="p">,</span> <span class="n">model_b_gbm</span> <span class="o">=</span> <span class="n">estimate_ab_lightgbm</span><span class="p">(</span><span class="n">X_gbm</span><span class="p">,</span> <span class="n">t_gbm</span><span class="p">)</span>
<span class="n">x_grid_gbm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_gbm</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_gbm</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">a_est_gbm</span><span class="p">,</span> <span class="n">b_est_gbm</span> <span class="o">=</span> <span class="n">predict_ab_lightgbm</span><span class="p">(</span><span class="n">model_a_gbm</span><span class="p">,</span> <span class="n">model_b_gbm</span><span class="p">,</span> <span class="n">x_grid_gbm</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">x_grid_gbm</span><span class="p">,</span> <span class="n">a_est_gbm</span><span class="p">,</span> <span class="n">b_est_gbm</span><span class="p">,</span> <span class="n">a_gbm</span><span class="p">,</span> <span class="n">b_gbm</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;(GBM)&quot;</span><span class="p">)</span>

<span class="c1">###################################</span>
<span class="c1"># 3. Ornstein-Uhlenbeck (OU)</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">t_ou</span><span class="p">,</span> <span class="n">X_ou</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_ou</span><span class="p">,</span> <span class="n">b_ou</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">model_a_ou</span><span class="p">,</span> <span class="n">model_b_ou</span> <span class="o">=</span> <span class="n">estimate_ab_lightgbm</span><span class="p">(</span><span class="n">X_ou</span><span class="p">,</span> <span class="n">t_ou</span><span class="p">)</span>
<span class="n">x_grid_ou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_ou</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_ou</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">a_est_ou</span><span class="p">,</span> <span class="n">b_est_ou</span> <span class="o">=</span> <span class="n">predict_ab_lightgbm</span><span class="p">(</span><span class="n">model_a_ou</span><span class="p">,</span> <span class="n">model_b_ou</span><span class="p">,</span> <span class="n">x_grid_ou</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">x_grid_ou</span><span class="p">,</span> <span class="n">a_est_ou</span><span class="p">,</span> <span class="n">b_est_ou</span><span class="p">,</span> <span class="n">a_ou</span><span class="p">,</span> <span class="n">b_ou</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;(OU)&quot;</span><span class="p">)</span>

<span class="c1">###################################</span>
<span class="c1"># 4. Proceso Complejo</span>
<span class="c1">###################################</span>
<span class="k">def</span> <span class="nf">a_complex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_complex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">t_complex</span><span class="p">,</span> <span class="n">X_complex</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_complex</span><span class="p">,</span> <span class="n">b_complex</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">model_a_complex</span><span class="p">,</span> <span class="n">model_b_complex</span> <span class="o">=</span> <span class="n">estimate_ab_lightgbm</span><span class="p">(</span><span class="n">X_complex</span><span class="p">,</span> <span class="n">t_complex</span><span class="p">)</span>
<span class="n">x_grid_complex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_complex</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_complex</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">a_est_complex</span><span class="p">,</span> <span class="n">b_est_complex</span> <span class="o">=</span> <span class="n">predict_ab_lightgbm</span><span class="p">(</span><span class="n">model_a_complex</span><span class="p">,</span> <span class="n">model_b_complex</span><span class="p">,</span> <span class="n">x_grid_complex</span><span class="p">)</span>
<span class="n">plot_estimation</span><span class="p">(</span><span class="n">x_grid_complex</span><span class="p">,</span> <span class="n">a_est_complex</span><span class="p">,</span> <span class="n">b_est_complex</span><span class="p">,</span> <span class="n">a_complex</span><span class="p">,</span> <span class="n">b_complex</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;(Complejo)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/401ae01a734dacf80ddce39e1e01097a0003f9677163ce05244021261c188cd1.png" src="../_images/401ae01a734dacf80ddce39e1e01097a0003f9677163ce05244021261c188cd1.png" />
<img alt="../_images/41571e0ad71b90a7b68412ae5f6ca2d3d42a4c8b703359eb7e6f1c7c7d020200.png" src="../_images/41571e0ad71b90a7b68412ae5f6ca2d3d42a4c8b703359eb7e6f1c7c7d020200.png" />
<img alt="../_images/42bf73bee6fafdd9640313142f802d017c02ef3fe82a53371b3516a6b9949e99.png" src="../_images/42bf73bee6fafdd9640313142f802d017c02ef3fe82a53371b3516a6b9949e99.png" />
<img alt="../_images/c3be8eb7444e122089df4fe123bed9951a7e123618beac85e2bf730aa0f35d76.png" src="../_images/c3be8eb7444e122089df4fe123bed9951a7e123618beac85e2bf730aa0f35d76.png" />
</div>
</div>
<p>A continuación se presenta un ejemplo completo de inferencia bayesiana para estimar las funciones de deriva <span class="math notranslate nohighlight">\(a(x)\)</span> y difusión <span class="math notranslate nohighlight">\(b(x)\)</span> de un proceso estocástico usando un enfoque no paramétrico bayesiano con Procesos Gaussianos (GP) para modelar estas funciones. Utilizaremos el caso del proceso de Ornstein-Uhlenbeck (OU) como ejemplo.</p>
<p>El proceso OU sigue la EDE:</p>
<div class="math notranslate nohighlight">
\[dX_t = \theta(\mu - X_t)dt + \sigma dW_t\]</div>
<p>Aquí:</p>
<p>•	<span class="math notranslate nohighlight">\(a(x) = \theta(\mu - x)\)</span> (deriva lineal),</p>
<p>•	<span class="math notranslate nohighlight">\(b(x) = \sigma\)</span> (difusión constante).</p>
<p>El objetivo es, a partir de datos simulados, recuperar las funciones <span class="math notranslate nohighlight">\(a(x)\)</span> y <span class="math notranslate nohighlight">\(b(x)\)</span> sin asumir una forma funcional explícita, utilizando un método bayesiano que asigne priors tipo GP sobre estas funciones y use MCMC para obtener su distribución posterior.</p>
<p>Pasos del Ejemplo</p>
<ol class="arabic simple">
<li><p>Simular datos del proceso OU.</p></li>
<li><p>Plantear el modelo bayesiano:</p></li>
</ol>
<p>•	Asumiremos para la deriva a(x) un prior de proceso Gaussiano.
•	Asumiremos para <span class="math notranslate nohighlight">\(\log b(x)\)</span> otro GP, de modo que <span class="math notranslate nohighlight">\(b(x) = \exp(f_b(x))\)</span>, asegurando positividad.</p>
<ol class="arabic simple" start="3">
<li><p>Especificar la verosimilitud:
Dado <span class="math notranslate nohighlight">\(X_{t_i}\)</span> y los incrementos <span class="math notranslate nohighlight">\(\Delta X_i\)</span>,</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\Delta X_i \sim N(a(X_{t_i})\Delta t,\, b(X_{t_i})^2 \Delta t)\]</div>
<ol class="arabic simple" start="4">
<li><p>Inferencia con pymc (PyMC v4), usando MCMC.</p></li>
<li><p>Obtener las estimaciones posteriores y mostrarlas en un gráfico comparando con las funciones verdaderas.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>

<span class="c1"># 1. Simulación de datos del proceso OU</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="k">def</span> <span class="nf">a_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">T</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">n</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># condición inicial</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a_ou</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">dt</span> <span class="o">+</span> <span class="n">b_ou</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>

<span class="n">dX</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">X_prev</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># 2. Modelo Bayesiano con GP</span>
<span class="c1"># Queremos aproximar:</span>
<span class="c1"># a(x) y b(x).</span>
<span class="c1"># Modelaremos a(x) como GP y log(b(x)) también como GP.</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="c1"># Prior para a(x):</span>
    <span class="c1"># Suponemos a(x) ~ GP con media 0 (por simplicidad) y kernel RBF.</span>
    <span class="c1"># En casos reales podríamos poner una media a priori más informada.</span>
    <span class="n">length_scale_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;length_scale_a&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">cov_a</span> <span class="o">=</span> <span class="n">sigma_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">ExpQuad</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length_scale_a</span><span class="p">)</span>
    <span class="n">gp_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">Latent</span><span class="p">(</span><span class="n">cov_func</span><span class="o">=</span><span class="n">cov_a</span><span class="p">)</span>
    <span class="n">a_latent</span> <span class="o">=</span> <span class="n">gp_a</span><span class="o">.</span><span class="n">prior</span><span class="p">(</span><span class="s1">&#39;a_latent&#39;</span><span class="p">,</span> <span class="n">X_prev</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># Prior para log(b(x)):</span>
    <span class="c1"># De igual forma, log(b(x)) ~ GP con media log(0.1) (por ejemplo)</span>
    <span class="c1"># Esto sugiere un prior débilmente informativo centrado en b ~ 0.1</span>
    <span class="n">length_scale_b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;length_scale_b&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">sigma_b_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sigma_b&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">cov_b</span> <span class="o">=</span> <span class="n">sigma_b_</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">ExpQuad</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length_scale_b</span><span class="p">)</span>
    <span class="n">gp_b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">Latent</span><span class="p">(</span><span class="n">mean_func</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)),</span> <span class="n">cov_func</span><span class="o">=</span><span class="n">cov_b</span><span class="p">)</span>
    <span class="n">b_latent</span> <span class="o">=</span> <span class="n">gp_b</span><span class="o">.</span><span class="n">prior</span><span class="p">(</span><span class="s1">&#39;b_latent&#39;</span><span class="p">,</span> <span class="n">X_prev</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># Transformar log(b(x)) a b(x):</span>
    <span class="n">b_val</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;b_val&#39;</span><span class="p">,</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b_latent</span><span class="p">))</span>
    
    <span class="c1"># Likelihood:</span>
    <span class="c1"># dX_i ~ Normal(a_latent[i]*dt, (b_val[i]^2)*dt)</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">a_latent</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">b_val</span><span class="o">*</span><span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">dX</span><span class="p">)</span>

    <span class="c1"># 3. Inference con MCMC</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="c1"># Posterior summary</span>
<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;length_scale_a&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="s1">&#39;length_scale_b&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_b&#39;</span><span class="p">])</span>

<span class="c1"># 4. Obtener el posterior medio de a(x) y b(x)</span>
<span class="c1"># Podemos evaluar las funciones a(x) y b(x) en una rejilla de puntos</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

<span class="c1"># Para extraer la posterior de a en x_grid y b en x_grid necesitamos extender el GP:</span>
<span class="c1"># Podemos usar pm.gp.predictive para un GP Latent, pero aquí simulamos &quot;manual&quot;:</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="c1"># Construimos las matrices para predecir</span>
    <span class="n">X_new</span> <span class="o">=</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Para predecir a(x):</span>
    <span class="c1"># Tenemos la posterior de a_latent en los puntos X_prev</span>
    <span class="c1"># Para un GP Latent, necesitamos recomponer el GP a(x) posterior:</span>
    <span class="c1"># pm.gp.Latent no guarda directamente la función posterior. Haremos</span>
    <span class="c1"># una aproximación: tomamos muestras de a_latent y entrenamos una función kernel L*(...).</span>
    <span class="c1"># Sin embargo, en este ejemplo simplificado:</span>
    <span class="c1"># Podemos tomar la media posterior punto a punto usando un GP condicional.</span>
    <span class="c1"># Truco: volvemos a crear el gp_a con las muestras del posterior.</span>

    <span class="c1"># Por simplicidad (y para que el ejemplo sea autocontenido):</span>
    <span class="c1"># Tomaremos la media posterior aproximando que el posterior medio de a</span>
    <span class="c1"># es la media de a_latent posterior en los puntos observados y luego</span>
    <span class="c1"># usaremos una interpolación GP en x_grid.</span>
    <span class="c1"># Una aproximación sencilla (no exacta): </span>
    <span class="c1"># Tomamos la media posterior punto a punto de a_latent y b_latent en X_prev</span>
    <span class="n">a_mean_posterior</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;a_latent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span><span class="s1">&#39;draw&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
    <span class="n">b_log_mean_posterior</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;b_latent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span><span class="s1">&#39;draw&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
    
    <span class="c1"># Para una predicción más correcta, habría que reconstruir el GP posterior completo.</span>
    <span class="c1"># Aquí haremos un atajo: usaremos la regresión local lineal a modo de interpolación </span>
    <span class="c1"># o un spline para mostrar el resultado aproximado.</span>
    <span class="c1"># Esto es solo demostrativo, en una aplicación real se usaría pm.gp.conditional()</span>
    <span class="c1"># tras haber definido gp_a y gp_b con pm.gp.Marginal o pm.gp.LatentPost y datos auxiliares.</span>
    
    <span class="c1"># Usaremos np.interp como aproximación rápida:</span>
    <span class="c1"># Ordenamos X_prev y sus valores medios:</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">X_prev</span><span class="p">)</span>
    <span class="n">X_prev_sorted</span> <span class="o">=</span> <span class="n">X_prev</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
    <span class="n">a_sorted</span> <span class="o">=</span> <span class="n">a_mean_posterior</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
    <span class="n">b_log_sorted</span> <span class="o">=</span> <span class="n">b_log_mean_posterior</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
    
    <span class="n">a_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">X_prev_sorted</span><span class="p">,</span> <span class="n">a_sorted</span><span class="p">)</span>
    <span class="n">b_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">X_prev_sorted</span><span class="p">,</span> <span class="n">b_log_sorted</span><span class="p">))</span>


<span class="c1"># 5. Graficar las estimaciones</span>
<span class="n">a_true_vals</span> <span class="o">=</span> <span class="n">a_ou</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
<span class="n">b_true_vals</span> <span class="o">=</span> <span class="n">b_ou</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a(x) posterior mean&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_true_vals</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a(x) true&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;a(x)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Estimación de la deriva (Bayesiano-GP)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">b_est</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b(x) posterior mean&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">b_true_vals</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b(x) true&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;b(x)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Estimación de la difusión (Bayesiano-GP)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 4 jobs)
NUTS: [length_scale_a, sigma_a, a_latent_rotated_, length_scale_b, sigma_b, b_latent_rotated_]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='4' class='' max='4000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      0.10% [4/4000 01:04&lt;17:57:41 Sampling 2 chains, 0 divergences]
    </div>
    </div><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">62</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span>     <span class="n">obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">a_latent</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">b_val</span><span class="o">*</span><span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">dX</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">61</span>     <span class="c1"># 3. Inference con MCMC</span>
<span class="ne">---&gt; </span><span class="mi">62</span>     <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span> <span class="c1"># Posterior summary</span>
<span class="g g-Whitespace">     </span><span class="mi">65</span> <span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;length_scale_a&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="s1">&#39;length_scale_b&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_b&#39;</span><span class="p">])</span>

<span class="nn">File ~/.pyenv/versions/3.9.7/lib/python3.9/site-packages/pymc/sampling/mcmc.py:826,</span> in <span class="ni">sample</span><span class="nt">(draws, tune, chains, cores, random_seed, progressbar, step, var_names, nuts_sampler, initvals, init, jitter_max_retries, n_init, trace, discard_tuned_samples, compute_convergence_checks, keep_warning_stat, return_inferencedata, idata_kwargs, nuts_sampler_kwargs, callback, mp_ctx, model, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">822</span> <span class="n">t_sampling</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span>
<span class="g g-Whitespace">    </span><span class="mi">824</span> <span class="c1"># Packaging, validating and returning the result was extracted</span>
<span class="g g-Whitespace">    </span><span class="mi">825</span> <span class="c1"># into a function to make it easier to test and refactor.</span>
<span class="ne">--&gt; </span><span class="mi">826</span> <span class="k">return</span> <span class="n">_sample_return</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">827</span>     <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">828</span>     <span class="n">traces</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">829</span>     <span class="n">tune</span><span class="o">=</span><span class="n">tune</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">830</span>     <span class="n">t_sampling</span><span class="o">=</span><span class="n">t_sampling</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">831</span>     <span class="n">discard_tuned_samples</span><span class="o">=</span><span class="n">discard_tuned_samples</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">832</span>     <span class="n">compute_convergence_checks</span><span class="o">=</span><span class="n">compute_convergence_checks</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">833</span>     <span class="n">return_inferencedata</span><span class="o">=</span><span class="n">return_inferencedata</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">834</span>     <span class="n">keep_warning_stat</span><span class="o">=</span><span class="n">keep_warning_stat</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">835</span>     <span class="n">idata_kwargs</span><span class="o">=</span><span class="n">idata_kwargs</span> <span class="ow">or</span> <span class="p">{},</span>
<span class="g g-Whitespace">    </span><span class="mi">836</span>     <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">837</span> <span class="p">)</span>

<span class="nn">File ~/.pyenv/versions/3.9.7/lib/python3.9/site-packages/pymc/sampling/mcmc.py:857,</span> in <span class="ni">_sample_return</span><span class="nt">(run, traces, tune, t_sampling, discard_tuned_samples, compute_convergence_checks, return_inferencedata, keep_warning_stat, idata_kwargs, model)</span>
<span class="g g-Whitespace">    </span><span class="mi">855</span> <span class="c1"># Pick and slice chains to keep the maximum number of samples</span>
<span class="g g-Whitespace">    </span><span class="mi">856</span> <span class="k">if</span> <span class="n">discard_tuned_samples</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">857</span>     <span class="n">traces</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">_choose_chains</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">tune</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">858</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">859</span>     <span class="n">traces</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">_choose_chains</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="nn">File ~/.pyenv/versions/3.9.7/lib/python3.9/site-packages/pymc/backends/base.py:595,</span> in <span class="ni">_choose_chains</span><span class="nt">(traces, tune)</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span> <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span> <span class="o">-</span> <span class="n">tune</span><span class="p">)</span> <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">594</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lengths</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">595</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough samples to build a trace.&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">597</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">598</span> <span class="n">l_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lengths</span><span class="p">)[</span><span class="n">idxs</span><span class="p">]</span>

<span class="ne">ValueError</span>: Not enough samples to build a trace.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>

<span class="c1">#===========================================================</span>
<span class="c1"># Definiciones de los modelos</span>
<span class="c1">#===========================================================</span>
<span class="k">def</span> <span class="nf">simulate_sde</span><span class="p">(</span><span class="n">a_func</span><span class="p">,</span> <span class="n">b_func</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">n</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">dt</span> <span class="o">+</span> <span class="n">b_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span>

<span class="c1"># Modelos:</span>
<span class="c1"># 1. ABM: a(x)=mu=0.1, b(x)=sigma=0.2</span>
<span class="k">def</span> <span class="nf">a_abm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">b_abm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># 2. GBM: dX = alpha*X dt + beta*X dW</span>
<span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">;</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.25</span>
<span class="k">def</span> <span class="nf">a_gbm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="n">alpha</span><span class="o">*</span><span class="n">x</span>
<span class="k">def</span> <span class="nf">b_gbm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="n">beta</span><span class="o">*</span><span class="n">x</span>

<span class="c1"># 3. OU: dX = theta(mu - X)dt + sigma dW</span>
<span class="n">theta</span><span class="o">=</span><span class="mf">2.0</span><span class="p">;</span> <span class="n">mu</span><span class="o">=</span><span class="mf">1.0</span><span class="p">;</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.3</span>
<span class="k">def</span> <span class="nf">a_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">b_ou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># 4. Complejo: a(x)=sin(x), b(x)=sqrt(0.1+0.05*x^2)</span>
<span class="k">def</span> <span class="nf">a_complex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">b_complex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.1</span><span class="o">+</span><span class="mf">0.05</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ABM&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a_abm</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">b_abm</span><span class="p">,</span> <span class="s2">&quot;X0&quot;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">},</span>
    <span class="s2">&quot;GBM&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a_gbm</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">b_gbm</span><span class="p">,</span> <span class="s2">&quot;X0&quot;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">},</span>
    <span class="s2">&quot;OU&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a_ou</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">b_ou</span><span class="p">,</span> <span class="s2">&quot;X0&quot;</span><span class="p">:</span><span class="mf">2.0</span><span class="p">},</span>
    <span class="s2">&quot;COMPLEJO&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a_complex</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">b_complex</span><span class="p">,</span> <span class="s2">&quot;X0&quot;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">#===========================================================</span>
<span class="c1"># Función auxiliar para el modelado bayesiano con GPs</span>
<span class="c1">#===========================================================</span>
<span class="k">def</span> <span class="nf">bayesian_inference</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dX</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">X_prev</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
        <span class="c1"># Priors GP para a(x)</span>
        <span class="n">length_scale_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;length_scale_a&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">cov_a</span> <span class="o">=</span> <span class="n">sigma_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">ExpQuad</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length_scale_a</span><span class="p">)</span>
        <span class="n">gp_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">Latent</span><span class="p">(</span><span class="n">cov_func</span><span class="o">=</span><span class="n">cov_a</span><span class="p">)</span>
        <span class="n">a_latent</span> <span class="o">=</span> <span class="n">gp_a</span><span class="o">.</span><span class="n">prior</span><span class="p">(</span><span class="s1">&#39;a_latent&#39;</span><span class="p">,</span> <span class="n">X_prev</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Priors GP para log(b(x))</span>
        <span class="n">length_scale_b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;length_scale_b&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">sigma_b_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sigma_b&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">cov_b</span> <span class="o">=</span> <span class="n">sigma_b_</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">ExpQuad</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length_scale_b</span><span class="p">)</span>
        <span class="n">gp_b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">Latent</span><span class="p">(</span><span class="n">mean_func</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)),</span> <span class="n">cov_func</span><span class="o">=</span><span class="n">cov_b</span><span class="p">)</span>
        <span class="n">b_latent</span> <span class="o">=</span> <span class="n">gp_b</span><span class="o">.</span><span class="n">prior</span><span class="p">(</span><span class="s1">&#39;b_latent&#39;</span><span class="p">,</span> <span class="n">X_prev</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">b_val</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;b_val&#39;</span><span class="p">,</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b_latent</span><span class="p">))</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">a_latent</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">b_val</span><span class="o">*</span><span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">dX</span><span class="p">)</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X_prev</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">trace</span>

<span class="k">def</span> <span class="nf">posterior_mean_functions</span><span class="p">(</span><span class="n">X_prev</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">):</span>
    <span class="c1"># Extraer las medias posteriores de a_latent y b_latent</span>
    <span class="n">a_mean_posterior</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;a_latent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span><span class="s1">&#39;draw&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
    <span class="n">b_log_mean_posterior</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;b_latent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span><span class="s1">&#39;draw&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Interpolar las medias posteriores en x_grid</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">X_prev</span><span class="p">)</span>
    <span class="n">X_prev_sorted</span> <span class="o">=</span> <span class="n">X_prev</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
    <span class="n">a_sorted</span> <span class="o">=</span> <span class="n">a_mean_posterior</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
    <span class="n">b_log_sorted</span> <span class="o">=</span> <span class="n">b_log_mean_posterior</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>

    <span class="n">a_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">X_prev_sorted</span><span class="p">,</span> <span class="n">a_sorted</span><span class="p">)</span>
    <span class="n">b_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">X_prev_sorted</span><span class="p">,</span> <span class="n">b_log_sorted</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">a_est</span><span class="p">,</span> <span class="n">b_est</span>

<span class="c1">#===========================================================</span>
<span class="c1"># Bucle sobre los 4 modelos</span>
<span class="c1">#===========================================================</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">params_model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># Simular datos</span>
    <span class="n">a_func</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
    <span class="n">b_func</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>
    <span class="n">X0</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s2">&quot;X0&quot;</span><span class="p">]</span>
    <span class="n">T</span><span class="o">=</span><span class="mf">5.0</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">50</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_func</span><span class="p">,</span> <span class="n">b_func</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="n">X0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="c1"># Inferencia bayesiana</span>
    <span class="n">X_prev</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">bayesian_inference</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="c1"># Reconstruir estimaciones en una rejilla</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">a_est</span><span class="p">,</span> <span class="n">b_est</span> <span class="o">=</span> <span class="n">posterior_mean_functions</span><span class="p">(</span><span class="n">X_prev</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>

    <span class="n">a_true_vals</span> <span class="o">=</span> <span class="n">a_func</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
    <span class="n">b_true_vals</span> <span class="o">=</span> <span class="n">b_func</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>

    <span class="c1"># Graficar</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_est</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a(x) posterior mean&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a_true_vals</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a(x) true&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;a(x)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimación de la deriva (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">b_est</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b(x) posterior mean&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">b_true_vals</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b(x) true&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;b(x)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimación de la difusión (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Opcional: mostrar resumen del traza</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resumen del posterior para </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;length_scale_a&#39;</span><span class="p">,</span><span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span><span class="s1">&#39;length_scale_b&#39;</span><span class="p">,</span><span class="s1">&#39;sigma_b&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only 50 samples per chain. Reliable r-hat and ESS diagnostics require longer chains for accurate estimate.
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 4 jobs)
NUTS: [length_scale_a, sigma_a, a_latent_rotated_, length_scale_b, sigma_b, b_latent_rotated_]
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">104</span>
<span class="g g-Whitespace">    </span><span class="mi">102</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">simulate_sde</span><span class="p">(</span><span class="n">a_func</span><span class="p">,</span> <span class="n">b_func</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="n">X0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span> <span class="c1"># Inferencia bayesiana</span>
<span class="ne">--&gt; </span><span class="mi">104</span> <span class="n">X_prev</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">bayesian_inference</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span> <span class="c1"># Reconstruir estimaciones en una rejilla</span>
<span class="g g-Whitespace">    </span><span class="mi">107</span> <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

<span class="nn">Cell In[4], line 72,</span> in <span class="ni">bayesian_inference</span><span class="nt">(X, t)</span>
<span class="g g-Whitespace">     </span><span class="mi">68</span>     <span class="n">b_val</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;b_val&#39;</span><span class="p">,</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b_latent</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span>     <span class="n">obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">a_latent</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">b_val</span><span class="o">*</span><span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">dX</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">72</span>     <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span> <span class="k">return</span> <span class="n">X_prev</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">trace</span>

<span class="nn">File ~/.pyenv/versions/3.9.7/lib/python3.9/site-packages/pymc/sampling/mcmc.py:826,</span> in <span class="ni">sample</span><span class="nt">(draws, tune, chains, cores, random_seed, progressbar, step, var_names, nuts_sampler, initvals, init, jitter_max_retries, n_init, trace, discard_tuned_samples, compute_convergence_checks, keep_warning_stat, return_inferencedata, idata_kwargs, nuts_sampler_kwargs, callback, mp_ctx, model, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">822</span> <span class="n">t_sampling</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span>
<span class="g g-Whitespace">    </span><span class="mi">824</span> <span class="c1"># Packaging, validating and returning the result was extracted</span>
<span class="g g-Whitespace">    </span><span class="mi">825</span> <span class="c1"># into a function to make it easier to test and refactor.</span>
<span class="ne">--&gt; </span><span class="mi">826</span> <span class="k">return</span> <span class="n">_sample_return</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">827</span>     <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">828</span>     <span class="n">traces</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">829</span>     <span class="n">tune</span><span class="o">=</span><span class="n">tune</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">830</span>     <span class="n">t_sampling</span><span class="o">=</span><span class="n">t_sampling</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">831</span>     <span class="n">discard_tuned_samples</span><span class="o">=</span><span class="n">discard_tuned_samples</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">832</span>     <span class="n">compute_convergence_checks</span><span class="o">=</span><span class="n">compute_convergence_checks</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">833</span>     <span class="n">return_inferencedata</span><span class="o">=</span><span class="n">return_inferencedata</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">834</span>     <span class="n">keep_warning_stat</span><span class="o">=</span><span class="n">keep_warning_stat</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">835</span>     <span class="n">idata_kwargs</span><span class="o">=</span><span class="n">idata_kwargs</span> <span class="ow">or</span> <span class="p">{},</span>
<span class="g g-Whitespace">    </span><span class="mi">836</span>     <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">837</span> <span class="p">)</span>

<span class="nn">File ~/.pyenv/versions/3.9.7/lib/python3.9/site-packages/pymc/sampling/mcmc.py:857,</span> in <span class="ni">_sample_return</span><span class="nt">(run, traces, tune, t_sampling, discard_tuned_samples, compute_convergence_checks, return_inferencedata, keep_warning_stat, idata_kwargs, model)</span>
<span class="g g-Whitespace">    </span><span class="mi">855</span> <span class="c1"># Pick and slice chains to keep the maximum number of samples</span>
<span class="g g-Whitespace">    </span><span class="mi">856</span> <span class="k">if</span> <span class="n">discard_tuned_samples</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">857</span>     <span class="n">traces</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">_choose_chains</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">tune</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">858</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">859</span>     <span class="n">traces</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">_choose_chains</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="nn">File ~/.pyenv/versions/3.9.7/lib/python3.9/site-packages/pymc/backends/base.py:595,</span> in <span class="ni">_choose_chains</span><span class="nt">(traces, tune)</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span> <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span> <span class="o">-</span> <span class="n">tune</span><span class="p">)</span> <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">594</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lengths</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">595</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough samples to build a trace.&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">597</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">598</span> <span class="n">l_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lengths</span><span class="p">)[</span><span class="n">idxs</span><span class="p">]</span>

<span class="ne">ValueError</span>: Not enough samples to build a trace.
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./proyectos"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Christian Álvarez
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>